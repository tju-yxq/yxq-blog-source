<span id="{{ .RelPermalink }}" class="leancloud_visitors meta_data_item" data-flag-title="">
    <span class="post-meta-item-icon">
      <span class="octicon octicon-eye"></span> 
    </span>
    <i class="fa fa-eye"></i>
    <span class="old-visitors-count" style="display: none;"></span>
    <span class="leancloud-visitors-count"></span>
</span>

<!-- View counter -->
<!--访问LeanCloud的js包装脚本-->
<script src="https://unpkg.com/leancloud-storage@latest/dist/av-min.js"></script>
<!--初始化LeanCloud的AV对象-->
<script>
	AV.init({
		appId: "{{ .Site.Params.leancloud_app_id }}",
		appKey: "{{ .Site.Params.leancloud_app_key }}",
		serverURL: "https://sgxibnqu.api.lncldglobal.com"
	});
</script>
<!--实现计数的js包装脚本-->
<script type="text/javascript">
function showTime(Counter) {
    var query = new AV.Query(Counter);
    var entries = [];
    var $visitors = $(".leancloud_visitors");

    $visitors.each(function() {
        entries.push($(this).attr("id").trim());
    });
    
    console.log("Loading counts for URLs: ", entries);

    query.containedIn('url', entries);
    query.find()
        .then(function(results) {
            var COUNT_CONTAINER_REF = '.leancloud-visitors-count';
            var OLD_COUNT_CONTAINER_REF = '.old-visitors-count';
            
            console.log("Found " + results.length + " existing counters");

            for (var i = 0; i < results.length; i++) {
                var item = results[i];
                var url = item.get('url');
                var time = item.get('time') || 0;
                var element = document.getElementById(url);

                console.log("Setting count for " + url + ": " + time);
                $(element).find(COUNT_CONTAINER_REF).text(time);
            }
            
            // 处理没有找到记录的URL
            for (var i = 0; i < entries.length; i++) {
                var url = entries[i];
                var element = document.getElementById(url);
                var countSpan = $(element).find(COUNT_CONTAINER_REF);
                if (countSpan.text() == '') {
                    var oldCountSpan = $(element).find(OLD_COUNT_CONTAINER_REF).text();
                    var defaultCount = 0;
                    if(oldCountSpan!=''){
                        defaultCount = parseInt(oldCountSpan);
                    }
                    console.log("No record found for " + url + ", setting default count: " + defaultCount);
                    countSpan.text(defaultCount);
                }
            }
        })
        .catch(function(error) {
            console.log("Error loading counts: " + error.code + " " + error.message);
            if (error.code === 101) {
                console.log("Counter table doesn't exist yet, showing default values");
                // 表不存在时，显示默认值0
                $visitors.find('.leancloud-visitors-count').text('0');
            } else {
                // 其他错误，也显示默认值
                console.log("Other error occurred, showing default values");
                $visitors.find('.leancloud-visitors-count').text('0');
            }
        });
}

function addCount(Counter) {
    var $visitors = $(".leancloud_visitors");
    var url = $visitors.attr('id').trim();
    var title = $visitors.attr('data-flag-title').trim();
    var query = new AV.Query(Counter);
    
    // 添加调试信息
    console.log("Current URL: " + url);
    console.log("Current Title: " + title);

    query.equalTo("url", url);
    query.find()
        .then(function(results) {
            if (results.length > 0) {
                var counter = results[0];
                var currentTime = counter.get('time') || 0;
                console.log("Current count: " + currentTime);
                
                // 使用 save 方法而不是 increment 来确保数据更新
                counter.set("time", currentTime + 1);
                counter.save()
                    .then(function(updatedCounter) {
                        var newTime = updatedCounter.get('time');
                        console.log("Updated count: " + newTime);
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(newTime);
                    })
                    .catch(function(error) {
                        console.log('Failed to save Visitor num, with error message: ' + error.message);
                        // 保存失败时至少显示当前值+1
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(currentTime + 1);
                    });
            } else {
                console.log("Creating new counter for URL: " + url);
                var newcounter = new Counter();
                /* Set ACL */
                var acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                newcounter.setACL(acl);
                /* End Set ACL */
                newcounter.set("title", title);
                newcounter.set("url", url);
                var OLD_COUNT_CONTAINER_REF = '.old-visitors-count';
                var $element = $(document.getElementById(url));
                var oldCountSpan = $element.find(OLD_COUNT_CONTAINER_REF).text();
                var initialCount = 1;
                if(oldCountSpan!=''){
                    initialCount = parseInt(oldCountSpan) + 1;
                }
                newcounter.set("time", initialCount);
                newcounter.save()
                    .then(function(savedCounter) {
                        console.log("New counter created with count: " + savedCounter.get('time'));
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(savedCounter.get('time'));
                    })
                    .catch(function(error) {
                        console.log('Failed to create new counter: ' + error.message);
                        // 创建失败时显示默认值
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(initialCount);
                    });
            }
        })
        .catch(function(error) {
            console.log('Error querying counter:' + error.code + " " + error.message);
            if (error.code === 101) {
                console.log("Counter table doesn't exist, creating first record");
                // 如果表不存在，尝试创建第一个记录
                var newcounter = new Counter();
                var acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                newcounter.setACL(acl);
                newcounter.set("title", title);
                newcounter.set("url", url);
                newcounter.set("time", 1);
                newcounter.save()
                    .then(function(savedCounter) {
                        console.log("First counter record created successfully");
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(savedCounter.get('time'));
                    })
                    .catch(function(saveError) {
                        console.log('Failed to create first counter record: ' + saveError.message);
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text('1');
                    });
            } else {
                // 其他查询失败时显示默认值
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text('1');
            }
        });
}
// 初始化Counter表结构
function initializeCounter() {
    var Counter = AV.Object.extend("Counter");
    var testQuery = new AV.Query(Counter);
    
    return testQuery.limit(1).find()
        .then(function(results) {
            console.log("Counter table exists");
            return Counter;
        })
        .catch(function(error) {
            if (error.code === 101) {
                console.log("Counter table doesn't exist, will be created automatically on first write");
                return Counter;
            }
            throw error;
        });
}

$(function() {
    initializeCounter()
        .then(function(Counter) {
            //如果只有1个.leancloud_visitors，则说明是博客页，需要显示查看数并将查看数+1
            //超过1个，则说明是文章列表，只需要显示查看数
            if ($('.leancloud_visitors').length == 1) {
                var url = $('.leancloud_visitors').attr('id').trim();
                var sessionKey = 'visited_' + url;
                
                // 检查会话存储中是否已经记录过这次访问
                if (!sessionStorage.getItem(sessionKey)) {
                    console.log("New visit detected, incrementing counter");
                    // 标记这次访问，防止页面刷新时重复计数
                    sessionStorage.setItem(sessionKey, 'true');
                    addCount(Counter);
                } else {
                    console.log("Already counted this visit, just showing count");
                    // 如果已经计数过，只显示当前数值
                    showTime(Counter);
                }
            } else {
                showTime(Counter);
            }
        })
        .catch(function(error) {
            console.log("Error initializing counter: " + error.code + " " + error.message);
            // 如果初始化失败，显示静态计数
            $('.leancloud-visitors-count').text('1');
        });
});
</script>
